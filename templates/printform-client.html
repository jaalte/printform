<!DOCTYPE html>
<html>
<head>
    <title>Plant Tag Printer</title>
    <link rel="stylesheet" href="/static/printform-client.css">
    <style>
        /* Main layout */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            gap: 20px;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            overflow: auto;
        }
        
        .left-panel {
            flex: 1;
            min-width: 0;
        }
        
        .right-panel {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            padding-left: 100px;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .right-panel {
                order: 1; /* Search appears below on smaller screens */
            }
        }
        
        /* Section headers */
        .section-header {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        /* Search styles */
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
        }
        
        .search-result {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .result-image {
            height: 120px;
            width: auto;
            object-fit: contain;
            background: white;
        }
        
        .result-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px;
            min-width: 80px;
        }
        
        .print-btn {
            padding: 6px 8px;
            border: 1px solid #3498db;
            background: #3498db;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Restart server button styles */
        .restart-server-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            pointer-events: auto;
        }
        
        .restart-server-tab {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .print-btn:hover {
            background: #2980b9;
        }
        
        .no-results {
            text-align: center;
            color: #7f8c8d;
            padding: 40px 20px;
            font-style: italic;
        }
        
        .search-loading {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
        }
        
        /* Right sidebar styles */
        .sidebar {
            position: fixed;
            right: 0;
            top: 20px; /* Move to top right instead of center */
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px 0 0 5px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .sidebar-btn {
            display: block;
            width: 130px; /* Set fixed width to prevent differences */
            padding: 8px 12px;
            margin: 5px 0;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            font-size: 14px;
            box-sizing: border-box; /* Ensure padding doesn't affect width */
        }
        .sidebar-btn:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Panel - Tag Editor -->
        <div class="left-panel">
            <div class="section-header">Create a tag</div>
            
            <!-- We put the template dropdown INSIDE the form so it's included in FormData() -->
            <form id="label-form">
                <!-- ### ADDED: Template selector at the top, so it's included in the same form. -->
                <div class="input-group">
                    <label for="template-select">Template:</label>
                    <select id="template-select" name="template_name">
                        <!-- Options get populated by JS -->
                    </select>
                </div>

                <div class="form-container">
                    <!-- Text Entry Section -->
                    <div class="data-inputs-container">
                        <strong>Text Entry</strong>
                        <div class="input-group">
                            <label for="main_text">Main Text:</label>
                            <input type="text" id="main_text" name="main_text" class="debounced-field">
                        </div>
                        <div class="input-group">
                            <label for="midtext">Cultivar:</label>
                            <input type="text" id="midtext" name="midtext" class="debounced-field">
                        </div>
                        <div class="input-group">
                            <label for="subtext">Subtext:</label>
                            <input type="text" id="subtext" name="subtext" class="debounced-field">
                        </div>
                    </div>

                    <!-- Offsets Section (Positioned to the right of inputs) -->
                    <div class="offset-controls">
                        <strong>Offsets</strong>
                        <!-- STEP=7 ON X-OFFSET -->
                        <div class="input-group">
                            <label for="x-offset">X:</label>
                            <input type="number" id="x-offset" name="x-offset" class="debounced-field" value="0" step="7">
                            <button type="button" id="x-offset-down" class="offset-btn">←</button>
                            <button type="button" id="x-offset-up" class="offset-btn">→</button>
                        </div>
                        <!-- STEP=1 ON Y-OFFSET -->
                        <div class="input-group">
                            <label for="y-offset">Y:</label>
                            <input type="number" id="y-offset" name="y-offset" class="debounced-field" value="0" step="1">
                            <button type="button" id="y-offset-down" class="offset-btn">↓</button>
                            <button type="button" id="y-offset-up" class="offset-btn">↑</button>
                        </div>
                    </div>
                    <div class="offset-controls">
                        <strong>Default Offset</strong>
                        <div class="input-group">
                            <label for="default_x_offset">X Offset:</label>
                            <input type="number" id="default_x_offset" name="default_x_offset" class="debounced-field" value="0" step="1">
                            <button type="button" id="default_x_offset_down" class="offset-btn">←</button>
                            <button type="button" id="default_x_offset_up" class="offset-btn">→</button>
                        </div>
                        <div class="input-group">
                            <label for="default_y_offset">Y Offset:</label>
                            <input type="number" id="default_y_offset" name="default_y_offset" class="debounced-field" value="0" step="1">
                            <button type="button" id="default_y_offset_down" class="offset-btn">↓</button>
                            <button type="button" id="default_y_offset_up" class="offset-btn">↑</button>
                        </div>
                    </div>
                </div>

                <!-- Label Preview Image -->
                <img id="label-image" src="" alt="Label Preview">

                <!-- Print & Save Controls -->
                <div id="print-controls">
                    <label for="print-count">Print Count:</label>
                    <!-- STEP=1 FOR PRINT COUNT -->
                    <input type="number" id="print-count" name="print-count" value="1" min="0" step="1">

                    <button type="button" id="print-one-btn">Print One</button>
                    <button type="button" id="print-batch-btn">Print Batch</button>
                    <button type="button" id="save-label-btn">Save Label</button>
                </div>
            </form>
        </div>
        
        <!-- Right Panel - Tag Search -->
        <div class="right-panel">
            <div class="section-header">Search tags</div>
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Search tags..." autocomplete="off">
            </div>
            <div id="search-results" class="search-results">
                <div class="no-results">Enter a search term to find tags...</div>
            </div>
        </div>
    </div>

    <!-- Toast Message -->
    <div id="toast-message" style="display: none; position: fixed; top: 20px; right: 20px; padding: 10px; border: 1px solid #333; background-color: #eee; color: #000; z-index: 1001; border-radius: 4px;"></div>

    <script>
    // Store the entire templates dict from /get_templates
    let allTemplates = {};

    // Generate a random session ID on page load
    const sessionId = Array.from(crypto.getRandomValues(new Uint8Array(8)))
      .map(b => b.toString(16).padStart(2, '0')).join('');

    // Debounce logic
    let debounceTimer = null;
    const DEBOUNCE_DELAY = 200;
    
    // Search debounce timer
    let searchDebounceTimer = null;
    const SEARCH_DEBOUNCE_DELAY = 300;

    function showToast(msg) {
      const toastMessage = document.getElementById('toast-message');
      toastMessage.textContent = msg;
      toastMessage.style.display = 'block';
      setTimeout(() => {
        toastMessage.style.display = 'none';
      }, 3000);
    }

    // Tag Search functionality
    function performSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        
        if (!query.trim()) {
            resultsContainer.innerHTML = '<div class="no-results">Enter a search term to find tags...</div>';
            return;
        }
        
        resultsContainer.innerHTML = '<div class="search-loading">Searching...</div>';
        
        fetch(`/search_labels?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results.length === 0) {
                    resultsContainer.innerHTML = '<div class="no-results">No tags found matching your search.</div>';
                    return;
                }
                
                const resultsHtml = data.results.map(result => {
                    const tooltip = `${result.filename}\nMatch: ${Math.round(result.similarity * 100)}%`;
                    return `
                        <div class="search-result" title="${tooltip}">
                            <img src="${result.full_path}" alt="${result.plant_name}" class="result-image">
                            <div class="result-actions">
                                <button class="print-btn" onclick="printBatch('${result.filename}')">Print Batch</button>
                                <button class="print-btn" onclick="printOne('${result.filename}')">Print One</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsContainer.innerHTML = resultsHtml;
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="no-results">Error searching tags. Please try again.</div>';
            });
    }
    
    function debouncedSearch(query) {
        if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
        }
        searchDebounceTimer = setTimeout(() => performSearch(query), SEARCH_DEBOUNCE_DELAY);
    }
    
    function printOne(filename) {
        fetch('/print_existing_label', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ filename: filename, count: 1 })
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showToast(`Error: ${data.error}`);
            } else {
                showToast('Printed one label.');
            }
        })
        .catch(err => {
            console.error('Print error:', err);
            showToast('Error printing label.');
        });
    }
    
    function printBatch(filename) {
        const count = prompt('How many copies to print?', '1');
        if (count === null || count === '') return;
        
        const numCount = parseInt(count);
        if (isNaN(numCount) || numCount <= 0) {
            showToast('Please enter a valid number.');
            return;
        }
        
        fetch('/print_existing_label', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ filename: filename, count: numCount })
        })
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showToast(`Error: ${data.error}`);
            } else {
                showToast(`Printed ${numCount} labels.`);
            }
        })
        .catch(err => {
            console.error('Print error:', err);
            showToast('Error printing labels.');
        });
    }

    // Tag Editor functionality
    function updatePreview() {
      const labelForm = document.getElementById('label-form');
      const labelImage = document.getElementById('label-image');
      const printControls = document.getElementById('print-controls');

      const formData = new FormData(labelForm);
      // Add session_id to the request
      formData.append('session_id', sessionId);

      fetch('/preview_label', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        console.log('Preview response:', data);
        if (data.image_path) {
          // Show the preview & print controls
          const cacheBuster = new Date().getTime();
          labelImage.src = `${data.image_path}?v=${cacheBuster}`;
          labelImage.style.display = 'block';
          printControls.style.display = 'block';
        } else if (data.error) {
          console.error('Preview error:', data.error);
        }
      })
      .catch(err => console.error('Preview error:', err));
    }

    function debouncedPreview() {
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }
      debounceTimer = setTimeout(updatePreview, DEBOUNCE_DELAY);
    }

    /**
     * Update each <label> in the .input-group to match the selected template's fields[].label
     * 'templateName' is actually the dictionary key (e.g., "Default Label Template").
     */
    function updateFormLabels(templateName) {
      const tmpl = allTemplates[templateName];
      if (!tmpl || !tmpl.fields) return;

      tmpl.fields.forEach(field => {
        const el = document.getElementById(field.name);
        if (el) {
          const labelEl = el.parentElement.querySelector('label');
          if (labelEl) {
            labelEl.textContent = field.label + ":";
          }
        }
      });
    }

    // On page load, populate the template dropdown
    const templateSelect = document.getElementById('template-select');
    fetch('/get_templates')
      .then(resp => resp.json())
      .then(templates => {
        // 'templates' is the entire dictionary keyed by each template's top-level "label".
        // E.g. { "Default Label Template": {...fields...}, "Some Other Template": {...} }

        allTemplates = templates;  // store globally

        // Clear anything existing
        templateSelect.innerHTML = '';

        // The keys are the template labels, like "Default Label Template"
        const keys = Object.keys(templates);
        for (const k of keys) {
          const opt = document.createElement('option');
          opt.value = k;       // e.g. "Default Label Template"
          opt.textContent = k; // same for displayed text
          templateSelect.appendChild(opt);
        }

        // Immediately select the first option (if any)
        if (keys.length > 0) {
          templateSelect.value = keys[0];
          // Update labels for the default template
          updateFormLabels(keys[0]);
        }

        // Trigger initial preview
        updatePreview();
      })
      .catch(err => console.error('Error loading templates:', err));

    // Search input handler
    document.getElementById('search-input').addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
    });

    // Re-generate preview AND update labels when the user changes the template
    templateSelect.addEventListener('change', () => {
      updateFormLabels(templateSelect.value);
      updatePreview();
    });

    // Attach input handlers for fields that need a preview update
    document.querySelectorAll('.debounced-field').forEach(field => {
      field.addEventListener('input', debouncedPreview);
    });

    // Offset button listeners
    document.getElementById('x-offset-down').addEventListener('click', (event) => {
      const xOffsetInput = document.getElementById('x-offset');
      const stepVal = parseFloat(xOffsetInput.step) || 1;
      xOffsetInput.value = (parseFloat(xOffsetInput.value) || 0) - stepVal;
      // Format as integer if stepVal is integer
      if (Number.isInteger(stepVal)) {
        xOffsetInput.value = String(Math.round(xOffsetInput.value));
      } else {
        xOffsetInput.value = String(parseFloat(xOffsetInput.value));
      }
      
      // If shift key is pressed, update preview and print
      if (event.shiftKey) {
        const labelForm = document.getElementById('label-form');
        const formData = new FormData(labelForm);
        formData.append('session_id', sessionId);

        fetch('/preview_label', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then(data => {
          if (data.image_path) {
            const labelImage = document.getElementById('label-image');
            const printControls = document.getElementById('print-controls');
            const cacheBuster = new Date().getTime();
            labelImage.src = `${data.image_path}?v=${cacheBuster}`;
            labelImage.style.display = 'block';
            printControls.style.display = 'block';
            
            // Now that preview is updated, print the label
            document.getElementById('print-one-btn').click();
          }
        })
        .catch(err => console.error('Preview error:', err));
      } else {
        debouncedPreview();
      }
    });
    document.getElementById('x-offset-up').addEventListener('click', (event) => {
      const xOffsetInput = document.getElementById('x-offset');
      const stepVal = parseFloat(xOffsetInput.step) || 1;
      xOffsetInput.value = (parseFloat(xOffsetInput.value) || 0) + stepVal;
      // Format as integer if stepVal is integer
      if (Number.isInteger(stepVal)) {
        xOffsetInput.value = String(Math.round(xOffsetInput.value));
      } else {
        xOffsetInput.value = String(parseFloat(xOffsetInput.value));
      }
      
      // If shift key is pressed, update preview and print
      if (event.shiftKey) {
        const labelForm = document.getElementById('label-form');
        const formData = new FormData(labelForm);
        formData.append('session_id', sessionId);

        fetch('/preview_label', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then(data => {
          if (data.image_path) {
            const labelImage = document.getElementById('label-image');
            const printControls = document.getElementById('print-controls');
            const cacheBuster = new Date().getTime();
            labelImage.src = `${data.image_path}?v=${cacheBuster}`;
            labelImage.style.display = 'block';
            printControls.style.display = 'block';
            
            // Now that preview is updated, print the label
            document.getElementById('print-one-btn').click();
          }
        })
        .catch(err => console.error('Preview error:', err));
      } else {
        debouncedPreview();
      }
    });

    // Print one label
    const printCountInput = document.getElementById('print-count');
    document.getElementById('print-one-btn').addEventListener('click', () => {
      const countVal = parseInt(printCountInput.value) || 1;
      fetch('/print_label', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ session_id: sessionId, count: 1 })
      })
      .then(r => r.json())
      .then(data => {
        console.log('Print one:', data);
        if (countVal > 0) {
          printCountInput.value = countVal - 1;
        }
        showToast('Printed one label.');
      })
      .catch(err => console.error(err));
    });

    // Print a batch
    document.getElementById('print-batch-btn').addEventListener('click', () => {
      const countVal = parseInt(printCountInput.value) || 0;
      if (countVal <= 0) {
        showToast("Can't print batch, no labels queued.");
        return;
      }
      fetch('/print_label', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ session_id: sessionId, count: countVal })
      })
      .then(r => r.json())
      .then(data => {
        console.log('Print batch:', data);
        printCountInput.value = 0;
        showToast(`Printed batch of ${countVal}.`);
      })
      .catch(err => console.error(err));
    });

    // Save the label
    document.getElementById('save-label-btn').addEventListener('click', () => {
      fetch('/save_label', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ session_id: sessionId })
      })
      .then(r => r.json())
      .then(data => {
        console.log('Save label:', data);
        if (data.error) {
          showToast(`Error: ${data.error}`);
        } else {
          showToast(`Saved to: ${data.saved_path}`);
        }
      })
      .catch(err => console.error(err));
    });

    // ADD SCROLL-WHEEL HANDLERS FOR NUMERIC INPUTS
    document.querySelectorAll('input[type="number"]').forEach(numberInput => {
      numberInput.addEventListener('wheel', (e) => {
        // Prevent page scroll while using the wheel on the input
        e.preventDefault();

        const stepValue = parseFloat(numberInput.step) || 1;
        let currentVal = parseFloat(numberInput.value) || 0;

        // e.deltaY < 0 => scrolling up
        if (e.deltaY < 0) {
          currentVal += stepValue;
        } else {
          currentVal -= stepValue;
        }

        // If step is an integer, force an integer output
        if (Number.isInteger(stepValue)) {
          currentVal = Math.round(currentVal);
        } else {
          // Otherwise allow decimals, but strip trailing .0
          currentVal = parseFloat(currentVal.toString());
        }
        numberInput.value = String(currentVal);

        debouncedPreview();
      }, { passive: false });
    });
    
    // Database migration button with confirmation
    const migrateBtn = document.getElementById('migrate-btn');
    if (migrateBtn) {
      migrateBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to migrate data from JSON files to the database? This operation is typically only needed once.')) {
          window.location.href = '/migrate-data';
        }
      });
    }
    // Restart server button functionality
    // This provides manual restart capability to address search bugs that occur
    // when the server runs for extended periods
    document.addEventListener('DOMContentLoaded', () => {
      const restartBtn = document.getElementById('restart-server-btn');
      if (restartBtn) {
        restartBtn.addEventListener('click', () => {
          fetch('/restart-server', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
          })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              // Server restart was successful
              showToast('Server restart in progress...');
              // Wait a moment then reload the page to reconnect to the new server instance
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else if (data.lock_text) {
              // Server is busy with a critical operation
              // Show user-friendly message with option to force restart
              if (confirm(`The server is waiting for action '${data.lock_text}' to complete. Restart anyways? This is generally safe to do, but you may need to re-save the current tag afterwards.`)) {
                // Force restart - ignore the lock
                fetch('/restart-server', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ force: true })
                })
                .then(r => r.json())
                .then(data => {
                  if (data.success) {
                    showToast('Server restart successful. Refreshing...');
                    setTimeout(() => {
                      window.location.reload();
                    }, 2000);
                  } else {
                    showToast(`Restart failed: ${data.message || data.error}`);
                  }
                })
                .catch(err => {
                  console.error('Restart error:', err);
                  showToast('Restart failed - check console for details');
                });
              }
            } else {
              // Other error occurred
              showToast(`Restart failed: ${data.message || data.error}`);
            }
          })
          .catch(err => {
            console.error('Restart error:', err);
            showToast('Restart failed - check console for details');
          });
        });
      }
    });
    </script>

    <!-- Restart server button - provides manual restart capability to address search bugs -->
    <div class="restart-server-container">
      <button class="restart-server-tab" id="restart-server-btn">
        Restart Server
      </button>
    </div>
</body>
</html>

